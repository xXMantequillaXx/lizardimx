---
import Button from '../common/Button.astro';
import Card from '../common/Card.astro';
---

<Card class="max-w-2xl">
  <h2 class="font-display text-2xl text-signal-white mb-6">Send Message</h2>

  <form id="contact-form" class="space-y-6">
    <!-- Honeypot field for spam prevention -->
    <input type="text" name="bot-field" style="display: none;" tabindex="-1" autocomplete="off" />

    <!-- Name -->
    <div>
      <label for="name" class="block text-intel-gray text-sm mb-2 font-display uppercase tracking-wider">
        Name <span class="text-alert-red">*</span>
      </label>
      <input
        type="text"
        id="name"
        name="name"
        required
        class="w-full px-4 py-3 bg-rich-black border border-steel-gray/30 focus:border-electric-cyan text-signal-white rounded transition-colors outline-none"
        placeholder="Your name"
      />
      <span class="error-message text-alert-red text-sm mt-1 hidden" data-error="name"></span>
    </div>

    <!-- Email -->
    <div>
      <label for="email" class="block text-intel-gray text-sm mb-2 font-display uppercase tracking-wider">
        Email <span class="text-alert-red">*</span>
      </label>
      <input
        type="email"
        id="email"
        name="email"
        required
        class="w-full px-4 py-3 bg-rich-black border border-steel-gray/30 focus:border-electric-cyan text-signal-white rounded transition-colors outline-none"
        placeholder="your.email@example.com"
      />
      <span class="error-message text-alert-red text-sm mt-1 hidden" data-error="email"></span>
    </div>

    <!-- Company -->
    <div>
      <label for="company" class="block text-intel-gray text-sm mb-2 font-display uppercase tracking-wider">
        Company
      </label>
      <input
        type="text"
        id="company"
        name="company"
        class="w-full px-4 py-3 bg-rich-black border border-steel-gray/30 focus:border-electric-cyan text-signal-white rounded transition-colors outline-none"
        placeholder="Your company (optional)"
      />
    </div>

    <!-- Service Interest -->
    <div>
      <label for="service" class="block text-intel-gray text-sm mb-2 font-display uppercase tracking-wider">
        Service Interest
      </label>
      <select
        id="service"
        name="service"
        class="w-full px-4 py-3 bg-rich-black border border-steel-gray/30 focus:border-electric-cyan text-signal-white rounded transition-colors outline-none"
      >
        <option value="">Select a service...</option>
        <option value="ai-consulting">AI Consulting</option>
        <option value="security">Security Services</option>
        <option value="brand-protection">Brand Protection</option>
        <option value="integrated">Integrated Security</option>
        <option value="other">Other</option>
      </select>
    </div>

    <!-- Message -->
    <div>
      <label for="message" class="block text-intel-gray text-sm mb-2 font-display uppercase tracking-wider">
        Message <span class="text-alert-red">*</span>
      </label>
      <textarea
        id="message"
        name="message"
        required
        rows="6"
        class="w-full px-4 py-3 bg-rich-black border border-steel-gray/30 focus:border-electric-cyan text-signal-white rounded transition-colors outline-none resize-none"
        placeholder="Tell us about your needs..."
      ></textarea>
      <span class="error-message text-alert-red text-sm mt-1 hidden" data-error="message"></span>
    </div>

    <!-- Submit Button -->
    <div>
      <Button type="submit" size="lg" class="w-full">
        Send Message
      </Button>
    </div>

    <!-- Success/Error Messages -->
    <div id="form-success" class="hidden p-4 bg-operational-green/10 border border-operational-green/30 rounded">
      <p class="text-operational-green text-sm">
        Message received. Expect response within 24-48 hours.
      </p>
    </div>

    <div id="form-error" class="hidden p-4 bg-alert-red/10 border border-alert-red/30 rounded">
      <p class="text-alert-red text-sm">
        Failed to send message. Please try again or contact us directly at <a href="mailto:hola@lizardi.mx" class="underline">hola@lizardi.mx</a>
      </p>
    </div>
  </form>
</Card>

<script>
  import { validateContactForm, sanitizeInput } from '../../lib/validation';

  const form = document.getElementById('contact-form') as HTMLFormElement;
  const successMsg = document.getElementById('form-success');
  const errorMsg = document.getElementById('form-error');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Hide previous messages
    successMsg?.classList.add('hidden');
    errorMsg?.classList.add('hidden');
    document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));

    // Get form data
    const formData = new FormData(form);
    const data = {
      name: sanitizeInput(formData.get('name') as string),
      email: sanitizeInput(formData.get('email') as string),
      company: sanitizeInput(formData.get('company') as string),
      service: formData.get('service') as string,
      message: sanitizeInput(formData.get('message') as string),
      honeypot: formData.get('bot-field') as string,
    };

    // Check honeypot
    if (data.honeypot) {
      console.log('Bot detected');
      return;
    }

    // Validate
    const validation = validateContactForm({
      name: data.name,
      email: data.email,
      message: data.message,
    });

    if (!validation.valid) {
      // Show errors
      Object.entries(validation.errors).forEach(([field, message]) => {
        const errorEl = document.querySelector(`[data-error="${field}"]`);
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.classList.remove('hidden');
        }
      });
      return;
    }

    // For MVP: Log to console (in production, send to backend)
    console.log('Form submission:', data);

    // Show success message
    successMsg?.classList.remove('hidden');
    form.reset();

    // In production, you would send to a serverless function:
    /*
    try {
      const response = await fetch('/api/contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        successMsg?.classList.remove('hidden');
        form.reset();
      } else {
        errorMsg?.classList.remove('hidden');
      }
    } catch (error) {
      errorMsg?.classList.remove('hidden');
    }
    */
  });
</script>
